<?php

// initialize the environment and get dependency injection container
$tServices = require __DIR__ . "/src/bootstrap.php";

// exception handling
set_exception_handler(function ($uException) use ($tServices) {
    $tFormatter = $tServices["formatter"];
    $tFormatter->writeHeader(2, "Error");
    $tFormatter->write($uException->getMessage());

    exit(1);
});

// set up server class
$tServer = new \SqlSync\Server\Server($tServices);

// set output
$tHandle = tmpfile();

// start dumping database to a local file
$tServer->dump("airmall", $tHandle);

// seek to the beginning
fseek($tHandle, 0);

// set up client class
$tClient = new \SqlSync\Client\Client($tServices);

// execute sql at the client
$tClient->connect();
$tClient->dropAndCreateDatabase("airmall");
$tClient->executeStream($tHandle);

// close and destroy the file
fclose($tHandle);

exit(0);
